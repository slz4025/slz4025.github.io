<!doctype html>
<html>
  <head>
    <title>Adventures in OpenBSD</title>
    <meta name="description" content="Adventures in OpenBSD">
    <link rel="stylesheet" type="text/css" href="../style.css">
  </head>
  <body>
    <div>
        <h1>Adventures in OpenBSD</h1>

        <p>Last updated: 12/29/2023</p>

        <p>
            When I'm offered a vegetable peeler to peel vegetables,
            I stick to slivering with the knife
            (and think I'm quite good at it).
            I've been doing drawing for something like 1.5-2 decades,
            and have learned I most prefer drawing with one pencil in
            one color, preferably HB graphite. 
            In essence, I prefer having one tool to do many things.
            I think this is an extension of my personal philosophy
            to avoid stuff as much as possible.
        </p>

        <p>
            In 2023, I had been thinking about getting a new computer,
            preferably one with a new operating system and a new everything,
            starting over from my experiences with Linux, MacOS, 
            and especially Windows. I wanted to avoid the excess of
            apps, the scare of unnecessary privacy infringement,
            the sites bogged over a low-latency and low-bandwidth connection,
            and the overwhelming interfaces full of many very glossy
            and very round clicky bits. 
        </p>

        <p>
            So when I learned there was an operating system that emphasized
            minimalism, I knew it was destined for me.
            Indeed, as I've used OpenBSD for the past few months, I do 
            most tasks in the terminal or browser. I <i>rarely</i> open
            up any other GUI. In fact, here's what my monitor looks like
            right about now:
        </p>

        <img src="./images/monitor.png" />

        <p>
            Not only is OpenBSD minimal, it forces you to configure everything.
            Every little thing most people don't worry about: 
            how to display GUIs, how to let the browser access files, 
            how to make the resolution just work. I've dug through 5-10
            files just to get one thing done and made a number of small
            bash tools to control settings like audio and brightness,
            connect to wifi in a new area, and open up various viewers
            and editors for various files.
            In the process, I'm learning way more about how the underlying
            system works.
        </p>

        <p>
            OpenBSD isn't widely used, so StackOverFlow and ChatGPT
            aren't much help for finding solutions to problems.
            Instead, I've found most success in looking through others'
            personal blogs, perusing Reddit, following GitHub issues,
            or delving into the mostly-well-documented man pages.
            I'm starting to feel like an apprentice of some arcane and
            mystical art.
        </p>

        <p>
            Unfortunately, some stuff really is still a mystery to me
            because it's been so hard to find information on it,
            and I feel like this shouldn't be the case. Like, what exactly
            is the relationship between the various audio abstractions,
            and how am I supposed to turn on the mic, speakers,
            and camera on for meetings post-boot so that they all <i>work</i>,
            dammit?
        </p>

        <p>
            Anyways, in case there are others like me wondering what
            people have done with their OpenBSD, here are some of the
            highlights of what I did and currently do.
        </p>

        <hr>
        <h2>HARDWARE AND SETUP</h2>

        <p>
            I configured my Lenovo computer, a 
            <a href="https://www.lenovo.com/us/en/p/laptops/thinkpad/thinkpadx1/thinkpad-x1-carbon-gen-10-(14-inch-intel)/">ThinkPad X1 Carbon Gen 10</a>,
            through their website and chose the following options:
        </p>

        <ul>
            <li>Processor: 12th Gen Intel(R) Core(TM) i7-1270P</li>
            <li>Memory: 16 GB</li>
            <li>Disk: 256 GB</li>
            <li>Display: 14" WQUXGA 3840x2400 pixels, 324 dpi, 500 nits</li>
        </ul>

        <p> 
            By default, the Lenovo computer came with Windows 11. In order
            to set up OpenBSD on it, I did the following:
        </p>

        <ul>
            <li>on a separate computer got the 
                <a href="https://www.openbsd.org/faq/faq4.html#Download">
                latest version of OpenBSD</a> at the time, 
            which was 7.3 for my computer's architecture,
            amd64,
            <li>
                use the separate computer, to load the downloaded image
                onto a spare USB with <a href="https://rufus.ie/en/">Rufus</a>,
            </li>
            <li>plug the USB into the Lenovo computer,</li>
            <li>go to "advanced boot setup",</li>
            <li>
                disable secure boot so that I could boot from an external
                drive,
            </li>
            <li>set the USB drive I plugged in as first in the Boot order,</li>
            <li>reboot and enter BIOS,</li>
            <li>follow the OpenBSD installer guide.</li>
        </ul>

        <p>
            After that, OpenBSD was my computer's operating system. However,
            it was just a single terminal. To allow various sessions to run
            at once, I enabled
            <a href="https://man.openbsd.org/xenodm">xenodm</a>.
            Now from boot, the computer would go through a login process
            and allow me to have something like a normal desktop experience.
            I was not a fan of the default window manager, 
            <a href="https://man.openbsd.org/fvwm">fvwm</a>, so I modified
            the xenodm process to use 
            <a href="https://man.openbsd.org/cwm">cwm</a>
            instead, which I think is nice and simple. 
            I tweaked the display so that is starts off as blissfully black.
            Then I run Ctrl+Alt+Enter to open a terminal and do my thing.
        </p>

        <hr>
        <h2>BROWSER</h2>

        <p>
            A browser is useful for perusing the internet. It also
            doubles as my image and document renderer.
        </p>

        <p>
            I use <a href="https://github.com/qutebrowser/qutebrowser">
                qutebrowser</a>, which I enjoy because of its Vim-like experience.
            Unfortunately, because it is modal, and because focusing
            is only possible via the "Insert" mode, it's pretty painful
            to use interfaces that require a lot of changes in focus,
            like Google Sheets. It also 
            <a href="https://github.com/qutebrowser/qutebrowser/issues/1841">
                does not currently support full-page screenshots</a>.
        </p>

        <p>
            Because of this, I use
            <a href="https://openports.pl/path/www/mozilla-firefox">
                OpenBSD's port of firefox</a>.
        </p>

        <p>
            By default, firefox comes with Emacs bindings, which I
            find confusing. I disable them by doing the following:
        </p>

        <ul>
            <li>
                in <code>~/.config/gtk-2.0/gtkrc-2.0</code>, set:
                <pre class="multi"><code class="multi">
    gtk-key-theme-name="Default"
                </code></pre>
            </li>
            <li>
                in <code>~/.config/gtk-3.0/settings.ini</code>, set:
                <pre class="multi"><code class="multi">
    [Settings]
    gtk-key-theme-name=Default
                </code></pre>
            </li>
        </ul>

        <p>
            When I tried to upload files, I couldn't see my file system.
            To fix this, I chose a folder to upload files from, then
            went to <code>about:config</code>, then configured 
            <code>dom.input.fallbackUploadDir</code> to the folder path.
            Additionally, by default, Firefox can only open files from
            <code>~/Downloads</code>. To give it access to a filepath,
            I do <code>doas vim /etc/firefox</code>, then in
            <code>unveil.content</code> and <code>unveil.main</code> files,
            I add the filepath to be exposed and the permission bits.
        </p>

        <p>
            I enable the following protections in firefox to protect
            my privacy:
        </p>

        <ul>
            <li>
                use <a href="https://github.com/gorhill/uBlock">
                    uBlock Origin</a> for ad-blocking,
            </li>
            <li>
                disable cookies among other things by going to
                Settings > Privacy & Security > Enhanced Tracking Protection
                > Custom,
            </li>
            <li>
                use <a href="https://github.com/gorhill/uBlock">
                    CanvasBlocker</a> to minimize the uniqueness of my
                digital fingerprint so it's harder for third-parties
                to corrobate my presence in one place with my presence
                in another,
            </li>
            <li>
                appear more generic by manipulating my user agent by
                going to <code>about:config</code> and changing
                <code>general.useragent.override</code> to something
                more common.
            </li>
        </ul>

        <p>I do the following for qutebrowser:</p>

        <ul>
            <li>
                Have the python ad-blocker enabled via the setting,
                <code>content.blocking.enabled=true</code>,
            </li>
            <li>
                Disable cookies via the settings 
                <code>content.cookies.accept=never</code>
                and <code>content.cookies.store=false</code>,
            </li>
            <li>
                Disable Javascript per session with
                <code>:set content.javascript.enable false</code>,
            </li>
            <li>
                Have canvas reading diabled via the setting,
                <code>content.canvas_reading=false</code>.
            </li>
        </ul>

        <p>
            I used
            <a href="https://coveryourtracks.eff.org">Cover Your Tracks</a>
            to determine how protected I was against fingerprinting.
            OpenBSD, being quite rare, is pretty difficult
            to mask the uniqueness of. I'm guessing there's a lot
            more tricks one can pull to preserve their privacy
            if they are dedicated.
        </p>

        <hr>
        <h2>DISPLAY</h2>

        <p>
            Because I have a high dpi, everything looks like it's at half-size.
            I had a micro-mouse and tiny windows. To overcome this,
            I did the following:
        </p>

        <ul>
            <li>
                Let the renderer,
                <a href="https://man.openbsd.org/Xft.3">Xft</a>, know
                about the resolution. In <code>~/.Xresources</code>, set:
                <pre class="multi"><code class="multi">
    Xft.dpi: 324
                </code></pre>
            </li>
            <li>
                Use a bigger mouse. In <code>~/.Xresources</code>, set:
                <pre class="multi"><code class="multi">
    Xcursor.size: 64
    Xcursor.theme: dmz-aa
                </code></pre>
            </li>
            <li>
                Increase the resolution of 
                <a href="https://man.openbsd.org/xterm">xterm</a>,
                the terminal program. This can effectively be done by
                changing the font size. In <code>~/.xresources</code>, set:
                <pre class="multi"><code class="multi">
    xterm*faceSize: 12
                </code></pre>
            </li>
            <li>
                For browsers, I set the zoom level to 200-300%. You
                can do other tricks to increase the size; for example,
                in Firefox, you can set <code>layout.css.devPixelsPerPx</code>
                in <code>about:config</code> to something higher than the
                default of 1. You can also set the <code>GDK_SCALE</code>
                or <code>QT_SCALE_FACTOR</code> to something higher than 1
                to increase the size of GTK applications, like firefox,
                and Qt applications, like qutebrowser, respectively.
                However, this had some undesirable results so I chose not
                to do this.
            </li>
        </ul>

        <p>
            Some other things I do is shift the temperature to something
            warmer and dim the brightness to 25%.
            In <code>~/.xsession</code>, I run:
        </p>

        <pre class="multi"><code class="multi">
    redshift -P -O 5000 >> /dev/null
    xbacklight -set 25
        </code></pre>

        <hr>
        <h2>COMMUNICATIONS</h2>

        <p>
            Zoom is not supported on OpenBSD. Instead, you can use
            Google Meet.
        </p>

        <p>
            It took <i>quite</i> a bit of fiddling to get
            the audio and camera working. I still don't trust
            that my mental model of the audio abstractions is correct.
            I highly suspect that my setup won't work for someone
            else who doesn't have the same configuration as me.
        </p>

        <p>
            After quite a bit of testing, I do the following,
            which seems to work.
            I first connect our webcam to the computer via USB,
            then our microphone to the computer via USB,
            then our headset into the microphone, in that <i>exact</i> order.
            To let the hardware recognize the camera, I run
            the following:
        </p>

        <pre class="multi"><code class="multi">
  doas sysctl kern.video.record=1
        </code></pre>

        <p>
            Finally, I run the following to set the default audio to
            be the microphone connection, which allows both the
            microphone and headset to work correctly:
        </p>

        <pre class="multi"><code class="multi">
  latest=$(dmesg | grep "Microphones" | grep "uaudio" | tail -1) 
  conn=$(echo "$latest" | awk '{print $1}' | sed "s/uaudio//")
  if [[ $conn ]]
  then
      i=$((conn+1))
    doas sndiod -f "rsnd/$i"
    echo "Setting audio device $i as default"
  fi
        </code></pre>

        <p>
            All of these steps are encapsulated in a bash function
            which I call <code>meet</code>. I also have steps
            to disable everything, which is a function called
            <code>unmeet</code>. However, I find this all a pain,
            so in reality, I just use another device for communications.
        </p>

        <hr>
        <h2>DEVELOPMENT</h2>

        <p>
            I am doing some Python development. I usually set up a virtual
            environment and then just <code>pip</code> my dependencies.
            However, some dependencies are difficult to build via
            <code>pip</code>, like scipy, matplotlib, and numpy. Instead,
            what I do is install the 
            <a href="https://www.openbsd.org/faq/ports/ports.html">
                OpenBSD ports</a> for these packages.
            These become part of my global packages.
            When I need to use these packages,
            I copy the global environment to a new virtual environment using:
        </p>

        <pre class="multi"><code class="multi">
    python3 -m venv .venv --system-site-packages
        </code></pre>

        <p>
            Then I install the rest of my dependencies with <code>pip</code>
            in this environment. However, this means I'm stuck with a
            certain version of a ported package. So far, this hasn't
            been an issue.
        </p>

        <br>
        <br>
        <br>
        <br>
        <br>
    </div>
  </body>
</html>
